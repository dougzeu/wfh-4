<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FIWFHT - Home</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.1/dist/umd/supabase.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="icon" href="/favicon.ico" sizes="any">
    <link rel="icon" href="/favicon.svg" type="image/svg+xml">
    <style>
        /* Toast notification styles */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            transform: translateX(100%);
            transition: transform 0.3s ease-in-out;
            min-width: 300px;
            max-width: 90vw;
        }
        .toast.show {
            transform: translateX(0);
        }
        .toast.success {
            background: #A7EE43;
            color: #080F17;
        }
        .toast.error {
            background: #ef4444;
            color: white;
        }
        .toast.warning {
            background: #f59e0b;
            color: white;
        }
        
        /* Loading spinner */
        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid transparent;
            border-top: 2px solid currentColor;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Focus styles for accessibility */
        .day-selector:focus {
            outline: 2px solid #A7EE43;
            outline-offset: 2px;
        }
        
        /* Selection counter pulse animation */
        .selection-counter.updated {
            animation: pulse 0.3s ease-in-out;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        /* Improved mobile responsive styles */
        @media (max-width: 640px) {
            .day-selector-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.75rem;
            }
            
            .day-selector-grid .day-selector:nth-child(5) {
                grid-column: 1 / -1;
                max-width: 50%;
                margin: 0 auto;
            }
        }
        
        @media (min-width: 641px) {
            .day-selector-grid {
                display: flex;
                gap: 0.75rem;
                justify-content: center;
            }
        }
    </style>
</head>
<body class="bg-black min-h-screen font-jakarta">
    <!-- Skip to main content for screen readers -->
    <a href="#main-content" class="sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-4 bg-accent text-black px-4 py-2 rounded z-50">
        Skip to main content
    </a>

    <!-- Toast Notification Container -->
    <div id="toast-container" aria-live="polite" aria-atomic="true"></div>
    
    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black bg-opacity-50" role="dialog" aria-labelledby="modal-title" aria-describedby="modal-description">
        <div class="bg-black border border-white/20 rounded-lg p-6 max-w-md mx-4">
            <h3 id="modal-title" class="text-white font-semibold text-lg mb-2">Confirm Week Change</h3>
            <p id="modal-description" class="text-white/80 text-sm mb-4">You have unsaved selections. Changing weeks will clear your current selections. Continue?</p>
            <div class="flex gap-3 justify-end">
                <button id="modal-cancel" class="
                    px-4 py-2 text-white/80 hover:text-white 
                    transition-colors min-h-[44px]
                    focus:outline-none focus:ring-2 focus:ring-accent focus:ring-offset-2 focus:ring-offset-black
                ">Cancel</button>
                <button id="modal-confirm" class="
                    px-4 py-2 bg-accent text-black rounded 
                    hover:bg-accent/90 transition-colors min-h-[44px]
                    focus:outline-none focus:ring-2 focus:ring-accent focus:ring-offset-2 focus:ring-offset-black
                ">Continue</button>
            </div>
        </div>
    </div>

    <div class="relative size-full min-h-screen">
        <div class="min-h-inherit relative size-full">
            <div class="
                flex flex-col-reverse items-start justify-start 
                min-h-inherit px-4 sm:px-8 lg:px-12 py-0 
                relative size-full
            ">
                
                <!-- Header -->
                <header class="bg-black order-3 relative shrink-0 w-full" role="banner">
                    <div class="flex flex-row items-center relative size-full">
                        <div class="
                            flex flex-row items-center justify-between 
                            px-0 py-3 
                            relative w-full
                        ">
                            <!-- Logo -->
                            <div class="h-8 relative shrink-0">
                                <div class="
                                    flex flex-row gap-1.5 h-8 items-center justify-start 
                                    p-0 relative
                                ">
                                    <div class="relative shrink-0 size-8">
                                        <svg class="block size-full" fill="none" preserveAspectRatio="none" viewBox="0 0 32 32" aria-hidden="true">
                                            <path d="M10.6667 18.6667C10.6667 18.6667 12.6667 21.3333 16 21.3333C19.3333 21.3333 21.3333 18.6667 21.3333 18.6667M22.6667 12.32C22.14 12.9667 21.42 13.3333 20.6667 13.3333C19.9133 13.3333 19.2133 12.9667 18.6667 12.32M13.3333 12.32C12.8067 12.9667 12.0867 13.3333 11.3333 13.3333C10.58 13.3333 9.88 12.9667 9.33333 12.32M29.3333 16C29.3333 23.3638 23.3638 29.3333 16 29.3333C8.6362 29.3333 2.66667 23.3638 2.66667 16C2.66667 8.6362 8.6362 2.66667 16 2.66667C23.3638 2.66667 29.3333 8.6362 29.3333 16Z" stroke="#A7EE43" stroke-linecap="round" stroke-linejoin="round" stroke-width="3"/>
                                        </svg>
                                    </div>
                                    <div class="
                                        font-bold leading-[0] relative shrink-0 
                                        text-accent text-lg sm:text-xl lg:text-[24px] 
                                        text-left text-nowrap tracking-[-0.72px]
                                    ">
                                        <p class="block leading-none whitespace-pre">FIWFHT</p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- User Info -->
                            <div class="relative shrink-0">
                                <div class="
                                    flex flex-row gap-2 items-center justify-end 
                                    p-0 relative
                                ">
                                    <div class="
                                        font-medium leading-[0] relative shrink-0 
                                        text-white text-sm lg:text-[15px] text-left text-nowrap
                                    " id="user-name">
                                        <p class="block leading-[20px] whitespace-pre">{{ userName }}</p>
                                    </div>
                                    <button class="
                                        relative size-10 shrink-0 flex items-center justify-center 
                                        hover:bg-white/10 rounded transition-colors
                                        focus:outline-none focus:ring-2 focus:ring-accent focus:ring-offset-2 focus:ring-offset-black
                                    " title="Logout" aria-label="Logout">
                                        <svg class="block size-6" fill="none" preserveAspectRatio="none" viewBox="0 0 24 24" aria-hidden="true">
                                            <path d="M5 12H19M19 12L12 5M19 12L12 19" stroke="#D6DDE6" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"/>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Divider -->
                            <div class="absolute bottom-0 h-0 left-[-48px] sm:left-[-96px] right-[-48px] sm:right-[-96px]">
                                <div class="absolute bottom-[-0.75px] left-0 right-0 top-[-0.75px]">
                                    <svg class="block size-full" fill="none" preserveAspectRatio="none" viewBox="0 0 1536 2" aria-hidden="true">
                                        <path d="M0 1H1536" stroke="#D6DDE6" stroke-opacity="0.2" stroke-width="1.5"/>
                                    </svg>
                                </div>
                            </div>
                        </div>
                    </div>
                </header>

                <!-- Main Content -->
                <main class="order-2 relative shrink-0 w-full" id="main-content" role="main">
                    <div class="relative size-full">
                        <div class="
                            flex flex-col-reverse items-start justify-start 
                            px-0 py-6 sm:py-12 
                            relative w-full
                        ">
                            
                            <!-- Work From Home Section -->
                            <section class="bg-black relative shrink-0 w-full order-2" aria-labelledby="wfh-heading">
                                <div class="flex flex-col items-center relative size-full">
                                    <div class="
                                        flex flex-col gap-6 sm:gap-8 items-center justify-start 
                                        px-0 py-8 sm:py-16 
                                        relative w-full max-w-6xl
                                    ">
                                        
                                        <!-- Date Navigation -->
                                        <nav class="relative shrink-0" aria-label="Week navigation">
                                            <div class="
                                                flex flex-row gap-3 items-center justify-start 
                                                p-0 relative
                                            ">
                                                <button class="
                                                    flex items-center justify-center relative shrink-0 
                                                    hover:bg-[rgba(255,255,255,0.1)] p-2 rounded transition-colors 
                                                    size-10
                                                    focus:outline-none focus:ring-2 focus:ring-accent focus:ring-offset-2 focus:ring-offset-black
                                                " id="prevWeek" aria-label="Previous week">
                                                    <div class="flex-none rotate-[180deg] scale-y-[-100%]">
                                                        <svg class="relative size-6" fill="none" preserveAspectRatio="none" viewBox="0 0 24 24" aria-hidden="true">
                                                            <path d="M5 12H19M19 12L12 5M19 12L12 19" stroke="#D6DDE6" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"/>
                                                        </svg>
                                                    </div>
                                                </button>
                                                <div class="relative shrink-0 size-6">
                                                    <svg class="block size-full" fill="none" preserveAspectRatio="none" viewBox="0 0 24 24" aria-hidden="true">
                                                        <path d="M16 2V6M8 2V6M3 10H21M5 4H19C20.1046 4 21 4.89543 21 6V20C21 21.1046 20.1046 22 19 22H5C3.89543 22 3 21.1046 3 20V6C3 4.89543 3.89543 4 5 4Z" stroke="#D6DDE6" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"/>
                                                    </svg>
                                                </div>
                                                <div class="
                                                    font-medium leading-[0] relative shrink-0 
                                                    text-white text-sm lg:text-[15px] text-left text-nowrap
                                                ">
                                                    <p class="block leading-[20px] whitespace-pre" id="weekRange">May 25 - 30, 2025</p>
                                                </div>
                                                <button class="
                                                    relative size-10 shrink-0 flex items-center justify-center
                                                    hover:bg-[rgba(255,255,255,0.1)] p-2 rounded transition-colors 
                                                    focus:outline-none focus:ring-2 focus:ring-accent focus:ring-offset-2 focus:ring-offset-black
                                                " id="nextWeek" aria-label="Next week">
                                                    <svg class="block size-6" fill="none" preserveAspectRatio="none" viewBox="0 0 24 24" aria-hidden="true">
                                                        <path d="M5 12H19M19 12L12 5M19 12L12 19" stroke="#D6DDE6" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"/>
                                                    </svg>
                                                </button>
                                            </div>
                                        </nav>

                                        <!-- Section Title -->
                                        <div class="relative shrink-0 w-full">
                                            <div class="
                                                flex flex-col gap-2 items-center justify-start 
                                                leading-[0] p-0 relative text-white text-center w-full
                                            ">
                                                <h1 id="wfh-heading" class="
                                                    font-bold relative shrink-0 
                                                    text-xl sm:text-2xl lg:text-[28px] 
                                                    tracking-[-0.28px] max-w-full px-4
                                                ">
                                                    <span class="block leading-[32px]">Choose up to 2 days per week to work from home.</span>
                                                </h1>
                                                <p class="
                                                    font-normal relative shrink-0 
                                                    text-xs sm:text-sm text-nowrap
                                                ">
                                                    <span class="block leading-[20px] whitespace-pre">The next week will be set automatically, but you can adjust your days anytime.</span>
                                                </p>
                                            </div>
                                        </div>

                                        <!-- Selection Counter -->
                                        <div class="relative shrink-0">
                                            <div class="selection-counter font-medium text-white/80 text-sm" id="selection-counter">
                                                <span id="selected-count">1</span>/2 days selected
                                            </div>
                                        </div>

                                        <!-- Days Selection -->
                                        <div class="relative shrink-0 w-full max-w-4xl">
                                            <div class="day-selector-grid" role="group" aria-label="Select work from home days" id="day-selector-container">
                                                <!-- Day buttons will be generated by JavaScript -->
                                            </div>
                                        </div>

                                        <!-- Action Buttons -->
                                        <div class="
                                            flex flex-col sm:flex-row gap-3 items-center justify-center 
                                            w-full max-w-md
                                        ">
                                            <button 
                                                id="saveButton"
                                                class="
                                                    bg-accent text-black font-semibold
                                                    px-6 py-3 rounded-lg
                                                    hover:bg-accent/90 transition-colors
                                                    min-h-[44px] w-full sm:w-auto
                                                    focus:outline-none focus:ring-2 focus:ring-accent focus:ring-offset-2 focus:ring-offset-black
                                                    disabled:opacity-50 disabled:cursor-not-allowed
                                                "
                                            >
                                                <div class="flex items-center justify-center gap-2">
                                                    <div id="saveSpinner" class="spinner hidden"></div>
                                                    <span id="saveButtonText">Save Schedule</span>
                                                </div>
                                            </button>
                                            <button 
                                                id="clearButton"
                                                class="
                                                    bg-transparent text-white/80 font-medium border border-white/20
                                                    px-6 py-3 rounded-lg
                                                    hover:bg-white/10 hover:text-white transition-colors
                                                    min-h-[44px] w-full sm:w-auto
                                                    focus:outline-none focus:ring-2 focus:ring-accent focus:ring-offset-2 focus:ring-offset-black
                                                "
                                            >
                                                Clear All
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </section>

                            <!-- Vacation/Leave Management Section -->
                            <section class="bg-black relative shrink-0 w-full order-1.5" aria-labelledby="vacation-heading">
                                <div class="flex flex-col items-center relative size-full">
                                    <div class="
                                        flex flex-col gap-6 sm:gap-8 items-center justify-start 
                                        px-0 py-8 sm:py-16 
                                        relative w-full max-w-6xl
                                    ">
                                        
                                        <!-- Section Title -->
                                        <div class="relative shrink-0 w-full">
                                            <div class="
                                                flex flex-col gap-2 items-center justify-start 
                                                leading-[0] p-0 relative text-white text-center w-full
                                            ">
                                                <h2 id="vacation-heading" class="
                                                    font-bold relative shrink-0 
                                                    text-xl sm:text-2xl lg:text-[28px] 
                                                    tracking-[-0.28px] max-w-full
                                                ">
                                                    <span class="block leading-[32px]">Vacation & Leave Management</span>
                                                </h2>
                                                <p class="
                                                    font-normal relative shrink-0 
                                                    text-xs sm:text-sm text-white/80
                                                ">
                                                    <span class="block leading-[20px]">Set your vacation dates and time off</span>
                                                </p>
                                            </div>
                                        </div>

                                        <!-- Current Vacation Status -->
                                        <div class="relative shrink-0 w-full max-w-2xl">
                                            <div class="bg-white/5 border border-white/10 rounded-lg p-6">
                                                <div class="flex flex-col gap-4">
                                                    <div class="flex items-center justify-between">
                                                        <h3 class="text-white font-semibold text-lg">Current Leave Status</h3>
                                                        <button id="setVacationBtn" class="
                                                            bg-accent text-black font-medium px-4 py-2 rounded-lg
                                                            hover:bg-accent/90 transition-colors
                                                            focus:outline-none focus:ring-2 focus:ring-accent focus:ring-offset-2 focus:ring-offset-black
                                                        ">
                                                            Set Leave
                                                        </button>
                                                    </div>
                                                    
                                                    <!-- Vacation Status Display -->
                                                    <div id="vacationStatus" class="text-white/80">
                                                        <div id="noVacationMessage" class="text-sm">
                                                            No upcoming vacation scheduled
                                                        </div>
                                                        <div id="vacationDetails" class="hidden">
                                                            <div class="flex flex-col gap-2">
                                                                <div class="flex items-center gap-2">
                                                                    <div class="w-3 h-3 bg-orange-400 rounded-full"></div>
                                                                    <span class="text-sm font-medium text-orange-400">On Vacation</span>
                                                                </div>
                                                                <div class="text-sm">
                                                                    <span id="vacationDates"></span>
                                                                </div>
                                                                <div class="text-xs text-white/60">
                                                                    <span id="vacationDaysCount"></span>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </section>

                            <!-- Vacation Date Picker Modal -->
                            <div id="vacationModal" class="
                                fixed inset-0 z-50 hidden items-center justify-center 
                                bg-black bg-opacity-50 backdrop-blur-sm
                            " role="dialog" aria-labelledby="vacation-modal-title" aria-describedby="vacation-modal-description">
                                <div class="bg-black border border-white/20 rounded-lg p-6 max-w-md mx-4 w-full max-w-lg">
                                    <div class="flex flex-col gap-6">
                                        <!-- Modal Header -->
                                        <div class="flex items-center justify-between">
                                            <h3 id="vacation-modal-title" class="text-white font-semibold text-xl">Set Vacation Dates</h3>
                                            <button id="closeVacationModal" class="
                                                text-white/60 hover:text-white transition-colors p-2
                                                focus:outline-none focus:ring-2 focus:ring-accent focus:ring-offset-2 focus:ring-offset-black
                                            " aria-label="Close modal">
                                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <path d="m18 6-12 12M6 6l12 12"/>
                                                </svg>
                                            </button>
                                        </div>

                                        <!-- Date Inputs -->
                                        <div class="flex flex-col gap-4">
                                            <div class="flex flex-col gap-2">
                                                <label for="vacationStartDate" class="text-white font-medium text-sm">Start Date</label>
                                                <input 
                                                    type="date" 
                                                    id="vacationStartDate" 
                                                    class="
                                                        bg-white/10 border border-white/20 rounded-lg px-3 py-2
                                                        text-white placeholder-white/60
                                                        focus:outline-none focus:ring-2 focus:ring-accent focus:border-accent
                                                    "
                                                />
                                            </div>
                                            <div class="flex flex-col gap-2">
                                                <label for="vacationEndDate" class="text-white font-medium text-sm">End Date</label>
                                                <input 
                                                    type="date" 
                                                    id="vacationEndDate" 
                                                    class="
                                                        bg-white/10 border border-white/20 rounded-lg px-3 py-2
                                                        text-white placeholder-white/60
                                                        focus:outline-none focus:ring-2 focus:ring-accent focus:border-accent
                                                    "
                                                />
                                            </div>
                                            <div class="flex flex-col gap-2">
                                                <label for="vacationNotes" class="text-white font-medium text-sm">Notes (Optional)</label>
                                                <textarea 
                                                    id="vacationNotes" 
                                                    rows="3"
                                                    placeholder="Add any notes about your vacation..."
                                                    class="
                                                        bg-white/10 border border-white/20 rounded-lg px-3 py-2
                                                        text-white placeholder-white/60 resize-none
                                                        focus:outline-none focus:ring-2 focus:ring-accent focus:border-accent
                                                    "
                                                ></textarea>
                                            </div>
                                        </div>

                                        <!-- Vacation Summary -->
                                        <div id="vacationSummary" class="hidden bg-accent/10 border border-accent/20 rounded-lg p-4">
                                            <div class="text-accent text-sm font-medium mb-2">Vacation Summary:</div>
                                            <div id="vacationSummaryText" class="text-white/80 text-sm"></div>
                                        </div>

                                        <!-- Modal Actions -->
                                        <div class="flex gap-3 justify-end">
                                            <button id="clearVacationBtn" class="
                                                px-4 py-2 text-red-400 hover:text-red-300 font-medium
                                                transition-colors min-h-[44px] hidden
                                                focus:outline-none focus:ring-2 focus:ring-red-400 focus:ring-offset-2 focus:ring-offset-black
                                            ">Clear Vacation</button>
                                            <button id="cancelVacationBtn" class="
                                                px-4 py-2 text-white/80 hover:text-white font-medium
                                                transition-colors min-h-[44px]
                                                focus:outline-none focus:ring-2 focus:ring-accent focus:ring-offset-2 focus:ring-offset-black
                                            ">Cancel</button>
                                            <button id="saveVacationBtn" class="
                                                px-4 py-2 bg-accent text-black rounded font-semibold
                                                hover:bg-accent/90 transition-colors min-h-[44px]
                                                focus:outline-none focus:ring-2 focus:ring-accent focus:ring-offset-2 focus:ring-offset-black
                                                disabled:opacity-50 disabled:cursor-not-allowed
                                            ">
                                                <div class="flex items-center justify-center gap-2">
                                                    <div id="vacationSaveSpinner" class="spinner hidden"></div>
                                                    <span>Save Vacation</span>
                                                </div>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Who's in the Office Section -->
                            <section class="bg-black relative shrink-0 w-full order-1" aria-labelledby="office-heading">
                                <div class="flex flex-col items-center relative size-full">
                                    <div class="
                                        flex flex-col gap-6 sm:gap-8 items-center justify-start 
                                        px-0 py-8 sm:py-16 
                                        relative w-full max-w-6xl
                                    ">
                                        
                                        <!-- Section Title -->
                                        <div class="relative shrink-0 w-full">
                                            <div class="
                                                flex flex-col gap-2 items-center justify-start 
                                                leading-[0] p-0 relative text-white text-center w-full
                                            ">
                                                <h2 id="office-heading" class="
                                                    font-bold relative shrink-0 
                                                    text-xl sm:text-2xl lg:text-[28px] 
                                                    tracking-[-0.28px] max-w-full
                                                ">
                                                    <span class="block leading-[32px]">Who's in the office this week?</span>
                                                </h2>
                                            </div>
                                        </div>

                                        <!-- Week Navigation -->
                                        <div class="relative shrink-0 w-full mb-4">
                                            <div class="flex items-center justify-center gap-4">
                                                <button id="prev-week-office" class="
                                                    flex items-center justify-center size-10 
                                                    border border-white/20 rounded-lg 
                                                    hover:bg-white/10 transition-colors
                                                    focus:outline-none focus:ring-2 focus:ring-accent focus:ring-offset-2 focus:ring-offset-black
                                                " aria-label="Previous week">
                                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#D6DDE6" stroke-width="2" aria-hidden="true">
                                                        <path d="m15 18-6-6 6-6"/>
                                                    </svg>
                                                </button>
                                                <div id="office-week-display" class="text-white font-medium text-center min-w-[200px]">
                                                    <!-- Week will be displayed here -->
                                                </div>
                                                <button id="next-week-office" class="
                                                    flex items-center justify-center size-10 
                                                    border border-white/20 rounded-lg 
                                                    hover:bg-white/10 transition-colors
                                                    focus:outline-none focus:ring-2 focus:ring-accent focus:ring-offset-2 focus:ring-offset-black
                                                " aria-label="Next week">
                                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#D6DDE6" stroke-width="2" aria-hidden="true">
                                                        <path d="m9 18 6-6-6-6"/>
                                                    </svg>
                                                </button>
                                            </div>
                                        </div>

                                        <!-- Status Legend -->
                                        <div class="relative shrink-0 w-full mb-4">
                                            <div class="flex flex-wrap items-center justify-center gap-4 text-xs text-white/60">
                                                <div class="flex items-center gap-2">
                                                    <div class="bg-accent rounded-full size-4 flex items-center justify-center text-black text-xs">üè¢</div>
                                                    <span>In Office</span>
                                                </div>
                                                <div class="flex items-center gap-2">
                                                    <div class="bg-white/10 rounded-full size-4 flex items-center justify-center text-white/60 text-xs">üè†</div>
                                                    <span>Work from Home</span>
                                                </div>
                                                <div class="flex items-center gap-2">
                                                    <div class="bg-orange-400 rounded-full size-4 flex items-center justify-center text-black text-xs">üèñÔ∏è</div>
                                                    <span>On Vacation</span>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Office Status Table -->
                                        <div class="relative shrink-0 w-full">
                                            <div class="bg-white/5 border border-white/10 rounded-lg overflow-hidden">
                                                <!-- Loading State -->
                                                <div id="office-table-loading" class="flex items-center justify-center p-8">
                                                    <div class="spinner mr-3"></div>
                                                    <span class="text-white/80">Loading office schedule...</span>
                                                </div>
                                                
                                                <!-- Table Content -->
                                                <div id="office-table-content" class="hidden">
                                                    <!-- Desktop Table -->
                                                    <div class="hidden md:block overflow-x-auto">
                                                        <table class="w-full">
                                                            <thead class="border-b border-white/10">
                                                                <tr class="text-left">
                                                                    <th class="px-4 py-3 text-white font-semibold text-sm min-w-[200px]">Employee</th>
                                                                    <th id="table-header-mon" class="px-3 py-3 text-white font-semibold text-sm text-center min-w-[80px]">Mon</th>
                                                                    <th id="table-header-tue" class="px-3 py-3 text-white font-semibold text-sm text-center min-w-[80px]">Tue</th>
                                                                    <th id="table-header-wed" class="px-3 py-3 text-white font-semibold text-sm text-center min-w-[80px]">Wed</th>
                                                                    <th id="table-header-thu" class="px-3 py-3 text-white font-semibold text-sm text-center min-w-[80px]">Thu</th>
                                                                    <th id="table-header-fri" class="px-3 py-3 text-white font-semibold text-sm text-center min-w-[80px]">Fri</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody id="office-table-body">
                                                                <!-- Table rows will be generated by JavaScript -->
                                                            </tbody>
                                                        </table>
                                                    </div>

                                                    <!-- Mobile Cards -->
                                                    <div class="md:hidden" id="office-mobile-content">
                                                        <!-- Mobile cards will be generated by JavaScript -->
                                                    </div>
                                                </div>

                                                <!-- Error State -->
                                                <div id="office-table-error" class="hidden flex items-center justify-center p-8">
                                                    <div class="text-center">
                                                        <div class="text-red-400 text-sm mb-2">Failed to load office schedule</div>
                                                        <button id="retry-office-table" class="
                                                            text-accent text-sm underline hover:no-underline
                                                            focus:outline-none focus:ring-2 focus:ring-accent focus:ring-offset-2 focus:ring-offset-black
                                                        ">
                                                            Try again
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Divider -->
                                <div class="absolute bottom-0 h-0 left-[-48px] sm:left-[-96px] right-[-48px] sm:right-[-96px]">
                                    <div class="absolute bottom-[-0.75px] left-0 right-0 top-[-0.75px]">
                                        <svg class="block size-full" fill="none" preserveAspectRatio="none" viewBox="0 0 1536 2" aria-hidden="true">
                                            <path d="M0 1H1536" stroke="#D6DDE6" stroke-opacity="0.2" stroke-width="1.5"/>
                                        </svg>
                                    </div>
                                </div>
                            </section>
                        </div>
                    </div>
                </main>

                <!-- Footer -->
                <div class="bg-black h-12 order-1 shrink-0 w-full"></div>
            </div>
        </div>
    </div>

    <script>
        // Employee data (extracted from hardcoded HTML)
        const OFFICE_EMPLOYEES = [
            { name: 'Sophia Turner', email: 'sophia@healthboost.com' },
            { name: 'Michael Chen', email: 'michael@fitlife.com' },
            { name: 'Emma Johnson', email: 'emma@activelife.com' },
            { name: 'Liam Rodriguez', email: 'liam@performanceplus.com' },
            { name: 'Olivia Martin', email: 'olivia@vitalityhub.com' },
            { name: 'James Smith', email: 'james@powerup.com' },
            { name: 'Ava Brown', email: 'ava@dynamicfitness.com' },
            { name: 'Elijah Davis', email: 'elijah@strengthzone.com' },
            { name: 'Mia Wilson', email: 'mia@trainhard.com' },
            { name: 'Noah Garcia', email: 'noah@wellbeing.com' },
            { name: 'Isabella Lopez', email: 'isabella@moveforward.com' },
            { name: 'Lucas Taylor', email: 'lucas@totalfit.com' },
            { name: 'Charlotte Anderson', email: 'charlotte@energize.com' },
            { name: 'Benjamin Thomas', email: 'benjamin@revitalize.com' }
        ];

        // Global variables
        function getCurrentWeekStart() {
            const today = new Date();
            const dayOfWeek = today.getDay(); // 0 = Sunday, 1 = Monday, etc.
            const monday = new Date(today);
            // Calculate days back to Monday (1 = Monday)
            const daysToMonday = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
            monday.setDate(today.getDate() - daysToMonday);
            return monday;
        }
        
        let currentWeekStart = getCurrentWeekStart(); // Start from current week
        let selectedDays = ['tuesday']; // Initially Tuesday is selected
        let hasUnsavedChanges = false;
        const maxSelections = 2;
        const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        
        // Office table state
        let currentOfficeWeekStart = getCurrentWeekStart();
        let officeScheduleData = null;
        const weekdays = [
            { key: 'monday', name: 'Monday', short: 'Mon' },
            { key: 'tuesday', name: 'Tuesday', short: 'Tue' },
            { key: 'wednesday', name: 'Wednesday', short: 'Wed' },
            { key: 'thursday', name: 'Thursday', short: 'Thu' },
            { key: 'friday', name: 'Friday', short: 'Fri' }
        ];
        
        // Storage keys
        const STORAGE_KEYS = {
            SELECTIONS: 'wfh_selections',
            CURRENT_WEEK: 'wfh_current_week'
        };

        // Utility Functions
        function showToast(message, type = 'success', duration = 3000) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type} rounded-lg p-4 mb-2 shadow-lg`;
            toast.innerHTML = `
                <div class="flex items-center justify-between">
                    <span class="font-medium">${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" class="
                        ml-2 text-current opacity-70 hover:opacity-100 
                        size-6 flex items-center justify-center
                        focus:outline-none focus:ring-1 focus:ring-current
                    " aria-label="Close notification">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                    </button>
                </div>
            `;
            
            container.appendChild(toast);
            
            // Trigger animation
            setTimeout(() => toast.classList.add('show'), 100);
            
            // Auto remove
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.classList.remove('show');
                    setTimeout(() => toast.remove(), 300);
                }
            }, duration);
        }

        function showConfirmationModal(message, onConfirm) {
            const modal = document.getElementById('confirmation-modal');
            const confirmBtn = document.getElementById('modal-confirm');
            const cancelBtn = document.getElementById('modal-cancel');
            
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            
            // Set focus to cancel button for better UX
            cancelBtn.focus();
            
            const handleConfirm = () => {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
                onConfirm();
                cleanup();
            };
            
            const handleCancel = () => {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
                cleanup();
            };
            
            const cleanup = () => {
                confirmBtn.removeEventListener('click', handleConfirm);
                cancelBtn.removeEventListener('click', handleCancel);
                document.removeEventListener('keydown', handleEscape);
            };
            
            const handleEscape = (e) => {
                if (e.key === 'Escape') {
                    handleCancel();
                }
            };
            
            confirmBtn.addEventListener('click', handleConfirm);
            cancelBtn.addEventListener('click', handleCancel);
            document.addEventListener('keydown', handleEscape);
        }

        // Local Storage Functions
        function saveToLocalStorage() {
            const weekKey = getWeekKey(currentWeekStart);
            const data = {
                selectedDays: selectedDays,
                lastSaved: new Date().toISOString()
            };
            localStorage.setItem(`${STORAGE_KEYS.SELECTIONS}_${weekKey}`, JSON.stringify(data));
        }

        function loadFromLocalStorage() {
            const weekKey = getWeekKey(currentWeekStart);
            const data = localStorage.getItem(`${STORAGE_KEYS.SELECTIONS}_${weekKey}`);
            if (data) {
                try {
                    const parsed = JSON.parse(data);
                    selectedDays = parsed.selectedDays || [];
                    return true;
                } catch (e) {
                    console.warn('Failed to parse saved data', e);
                }
            }
            return false;
        }

        function getWeekKey(date) {
            const year = date.getFullYear();
            const month = date.getMonth();
            const day = date.getDate();
            return `${year}-${month}-${day}`;
        }

        // UI Update Functions
        function updateWeekDisplay() {
            const weekEnd = new Date(currentWeekStart);
            weekEnd.setDate(currentWeekStart.getDate() + 4); // Friday
            
            const startMonth = months[currentWeekStart.getMonth()];
            const endMonth = months[weekEnd.getMonth()];
            const startDay = currentWeekStart.getDate();
            const endDay = weekEnd.getDate();
            const year = currentWeekStart.getFullYear();
            
            let displayText;
            if (startMonth === endMonth) {
                displayText = `${startMonth} ${startDay} - ${endDay}, ${year}`;
            } else {
                displayText = `${startMonth} ${startDay} - ${endMonth} ${endDay}, ${year}`;
            }
            
            document.getElementById('weekRange').textContent = displayText;
            updateDayButtons();
        }

        function updateDayButtons() {
            const container = document.getElementById('day-selector-container');
            const currentDate = new Date(currentWeekStart);
            
            container.innerHTML = '';
            
            weekdays.forEach((dayInfo, index) => {
                const dayDate = new Date(currentDate);
                dayDate.setDate(currentDate.getDate() + index);
                
                const isSelected = selectedDays.includes(dayInfo.key);
                
                const button = document.createElement('button');
                button.className = `
                    relative rounded-lg shrink-0 w-full min-w-[100px] sm:w-[108px]
                    min-h-[80px] sm:min-h-[88px]
                    border-[1.5px] transition-colors day-selector
                    focus:outline-none focus:ring-2 focus:ring-accent focus:ring-offset-2 focus:ring-offset-black
                    ${isSelected 
                        ? 'bg-accent text-black border-accent' 
                        : 'bg-black text-white border-[rgba(214,221,230,0.2)] hover:bg-[rgba(255,255,255,0.04)]'
                    }
                `;
                
                button.setAttribute('data-day', dayInfo.key);
                button.setAttribute('data-date', dayDate.getDate());
                button.setAttribute('role', 'button');
                button.setAttribute('tabindex', '0');
                button.setAttribute('aria-pressed', isSelected ? 'true' : 'false');
                button.setAttribute('aria-label', `${dayInfo.name}, ${months[dayDate.getMonth()]} ${dayDate.getDate()}${isSelected ? ' - Selected' : ''}`);
                
                button.innerHTML = `
                    <div class="flex flex-col items-center justify-center relative size-full">
                        <div class="
                            flex flex-col gap-2 sm:gap-3 items-center justify-center 
                            leading-[0] px-3 py-4 relative text-center w-full
                        ">
                            <div class="font-semibold relative shrink-0 text-[11px] sm:text-[13px]">
                                <span class="block leading-[16px] text-nowrap whitespace-pre">${dayInfo.name}</span>
                            </div>
                            <div class="font-medium relative shrink-0 text-lg sm:text-[22px]">
                                <span class="block leading-[20px] text-nowrap whitespace-pre">${dayDate.getDate()}</span>
                            </div>
                        </div>
                    </div>
                `;
                
                container.appendChild(button);
            });
        }

        function updateSelectionCounter() {
            const counter = document.getElementById('selection-counter');
            const countElement = document.getElementById('selected-count');
            
            countElement.textContent = selectedDays.length;
            counter.classList.add('updated');
            
            setTimeout(() => {
                counter.classList.remove('updated');
            }, 300);
        }

        function updateSaveButtonState() {
            const saveButton = document.getElementById('saveButton');
            const saveButtonText = document.getElementById('saveButtonText');
            
            if (selectedDays.length === 0) {
                saveButton.disabled = true;
                saveButtonText.textContent = 'Select Days First';
            } else if (!hasUnsavedChanges) {
                saveButton.disabled = true;
                saveButtonText.textContent = 'Saved';
            } else {
                saveButton.disabled = false;
                saveButtonText.textContent = 'Save Schedule';
            }
        }

        // Office Schedule Table Functions
        async function loadOfficeSchedule() {
            showOfficeTableLoading();
            
            try {
                const weekStart = scheduleManager.getWeekStart(currentOfficeWeekStart);
                const { data, error } = await scheduleManager.getAllUsersWeeklyOfficeStatus(weekStart);
                
                if (error) throw error;
                
                officeScheduleData = data;
                updateOfficeWeekDisplay();
                renderOfficeTable();
                showOfficeTableContent();
                
            } catch (error) {
                console.error('Failed to load office schedule:', error);
                showOfficeTableError();
            }
        }

        function updateOfficeWeekDisplay() {
            const weekDisplay = document.getElementById('office-week-display');
            const startDate = new Date(currentOfficeWeekStart);
            const endDate = new Date(startDate);
            endDate.setDate(endDate.getDate() + 4); // Friday

            const startStr = `${months[startDate.getMonth()]} ${startDate.getDate()}`;
            const endStr = `${months[endDate.getMonth()]} ${endDate.getDate()}, ${endDate.getFullYear()}`;
            
            weekDisplay.textContent = `${startStr} - ${endStr}`;
            
            // Update table headers with dates
            if (officeScheduleData && officeScheduleData.weekDays) {
                officeScheduleData.weekDays.forEach((day, index) => {
                    const headerId = ['table-header-mon', 'table-header-tue', 'table-header-wed', 'table-header-thu', 'table-header-fri'][index];
                    const header = document.getElementById(headerId);
                    if (header) {
                        const date = new Date(day.date);
                        header.innerHTML = `
                            <div class="text-center">
                                <div class="font-semibold">${day.dayShort}</div>
                                <div class="text-xs text-white/60">${date.getDate()}</div>
                            </div>
                        `;
                    }
                });
            }
        }

        function renderOfficeTable() {
            if (!officeScheduleData) return;
            
            renderDesktopTable();
            renderMobileCards();
        }

        function renderDesktopTable() {
            const tbody = document.getElementById('office-table-body');
            if (!tbody || !officeScheduleData) return;

            tbody.innerHTML = officeScheduleData.users.map(userStatus => {
                const statusCells = userStatus.dailyStatus.map(day => {
                    let statusClass, statusText, statusLabel;
                    
                    if (day.isOnVacation) {
                        statusClass = 'bg-orange-400 text-black';
                        statusText = 'üèñÔ∏è';
                        statusLabel = 'On Vacation';
                    } else if (day.isInOffice) {
                        statusClass = 'bg-accent text-black';
                        statusText = 'üè¢';
                        statusLabel = 'In Office';
                    } else {
                        statusClass = 'bg-white/10 text-white/60';
                        statusText = 'üè†';
                        statusLabel = 'Work from Home';
                    }
                    
                    return `
                        <td class="px-3 py-3 text-center">
                            <div class="
                                ${statusClass} 
                                rounded-full size-8 flex items-center justify-center 
                                mx-auto text-sm font-medium
                            " title="${statusLabel}">
                                ${statusText}
                            </div>
                        </td>
                    `;
                }).join('');

                return `
                    <tr class="border-b border-white/5 hover:bg-white/2 transition-colors">
                        <td class="px-4 py-3">
                            <div class="min-w-0">
                                <div class="font-medium text-white text-sm truncate">${userStatus.user.name}</div>
                                <div class="text-xs text-white/60 truncate">${userStatus.user.email}</div>
                                ${userStatus.user.department ? `<div class="text-xs text-white/40 truncate">${userStatus.user.department}</div>` : ''}
                            </div>
                        </td>
                        ${statusCells}
                    </tr>
                `;
            }).join('');
        }

        function renderMobileCards() {
            const container = document.getElementById('office-mobile-content');
            if (!container || !officeScheduleData) return;

            container.innerHTML = officeScheduleData.users.map(userStatus => {
                const statusDays = userStatus.dailyStatus.map(day => {
                    let statusClass, statusText, statusLabel;
                    
                    if (day.isOnVacation) {
                        statusClass = 'bg-orange-400 text-black';
                        statusText = 'üèñÔ∏è';
                        statusLabel = 'Vacation';
                    } else if (day.isInOffice) {
                        statusClass = 'bg-accent text-black';
                        statusText = 'üè¢';
                        statusLabel = 'Office';
                    } else {
                        statusClass = 'bg-white/10 text-white/60';
                        statusText = 'üè†';
                        statusLabel = 'WFH';
                    }
                    
                    return `
                        <div class="flex flex-col items-center gap-1">
                            <div class="text-xs text-white/60">${day.dayShort}</div>
                            <div class="
                                ${statusClass} 
                                rounded-full size-8 flex items-center justify-center 
                                text-sm font-medium
                            " title="${statusLabel}">
                                ${statusText}
                            </div>
                        </div>
                    `;
                }).join('');

                return `
                    <div class="border-b border-white/10 p-4 last:border-b-0">
                        <div class="mb-3">
                            <div class="font-medium text-white text-sm">${userStatus.user.name}</div>
                            <div class="text-xs text-white/60">${userStatus.user.email}</div>
                            ${userStatus.user.department ? `<div class="text-xs text-white/40">${userStatus.user.department}</div>` : ''}
                        </div>
                        <div class="flex justify-between items-center gap-2">
                            ${statusDays}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function showOfficeTableLoading() {
            document.getElementById('office-table-loading').classList.remove('hidden');
            document.getElementById('office-table-content').classList.add('hidden');
            document.getElementById('office-table-error').classList.add('hidden');
        }

        function showOfficeTableContent() {
            document.getElementById('office-table-loading').classList.add('hidden');
            document.getElementById('office-table-content').classList.remove('hidden');
            document.getElementById('office-table-error').classList.add('hidden');
        }

        function showOfficeTableError() {
            document.getElementById('office-table-loading').classList.add('hidden');
            document.getElementById('office-table-content').classList.add('hidden');
            document.getElementById('office-table-error').classList.remove('hidden');
        }

        function setupOfficeTableEventListeners() {
            // Week navigation
            document.getElementById('prev-week-office').addEventListener('click', () => {
                currentOfficeWeekStart.setDate(currentOfficeWeekStart.getDate() - 7);
                loadOfficeSchedule();
            });

            document.getElementById('next-week-office').addEventListener('click', () => {
                currentOfficeWeekStart.setDate(currentOfficeWeekStart.getDate() + 7);
                loadOfficeSchedule();
            });

            // Retry button
            document.getElementById('retry-office-table').addEventListener('click', () => {
                loadOfficeSchedule();
            });
        }

        // Day Selector Functionality
        function setSelectedDayStyles(button) {
            button.className = button.className.replace(/bg-black|border-\[rgba\(214,221,230,0\.2\)\]|text-white/g, '');
            button.className += ' bg-accent text-black border-accent';
            button.setAttribute('aria-pressed', 'true');
            
            const label = button.getAttribute('aria-label');
            if (!label.includes('Selected')) {
                button.setAttribute('aria-label', label + ' - Selected');
            }
        }

        function resetDayStyles(button) {
            button.className = button.className.replace(/bg-accent|text-black|border-accent/g, '');
            button.className += ' bg-black text-white border-[rgba(214,221,230,0.2)] hover:bg-[rgba(255,255,255,0.04)]';
            button.setAttribute('aria-pressed', 'false');
            
            const label = button.getAttribute('aria-label');
            button.setAttribute('aria-label', label.replace(' - Selected', ''));
        }

        function updateDaySelector(button, day) {
            const isSelected = selectedDays.includes(day);
            
            if (isSelected) {
                // Deselect
                selectedDays = selectedDays.filter(d => d !== day);
                resetDayStyles(button);
                hasUnsavedChanges = true;
                showToast(`${day.charAt(0).toUpperCase() + day.slice(1)} deselected`, 'warning', 2000);
            } else {
                // Select (if under limit)
                if (selectedDays.length < maxSelections) {
                    selectedDays.push(day);
                    setSelectedDayStyles(button);
                    hasUnsavedChanges = true;
                    showToast(`${day.charAt(0).toUpperCase() + day.slice(1)} selected for WFH`, 'success', 2000);
                } else {
                    showToast('You can only select up to 2 days per week to work from home.', 'error', 4000);
                    return;
                }
            }
            
            updateSelectionCounter();
            updateSaveButtonState();
            saveToLocalStorage(); // Auto-save draft
        }

        // Date navigation functionality
        function changeWeek(direction) {
            const attemptChange = () => {
                const newWeekStart = new Date(currentWeekStart);
                newWeekStart.setDate(currentWeekStart.getDate() + (direction * 7));
                currentWeekStart = newWeekStart;
                
                // Reset selections when changing weeks
                selectedDays = [];
                
                hasUnsavedChanges = false;
                updateWeekDisplay();
                loadFromLocalStorage(); // Try to load saved selections for this week
                
                updateWeekDisplay(); // Update again with loaded data
                updateSelectionCounter();
                updateSaveButtonState();
                showToast(`Switched to ${direction > 0 ? 'next' : 'previous'} week`, 'success', 2000);
            };
            
            if (hasUnsavedChanges && selectedDays.length > 0) {
                showConfirmationModal(
                    'You have unsaved selections. Changing weeks will clear your current selections. Continue?',
                    attemptChange
                );
            } else {
                attemptChange();
            }
        }

        function clearAllSelections() {
            if (selectedDays.length === 0) {
                showToast('No selections to clear', 'warning', 2000);
                return;
            }
            
            selectedDays = [];
            updateDayButtons();
            
            hasUnsavedChanges = true;
            updateSelectionCounter();
            updateSaveButtonState();
            saveToLocalStorage();
            showToast('All selections cleared', 'success', 2000);
        }

        // Enhanced save functionality
        async function saveSchedule() {
            if (selectedDays.length === 0) {
                showToast('Please select at least one day to work from home.', 'error', 3000);
                return;
            }

            const saveButton = document.getElementById('saveButton');
            const saveSpinner = document.getElementById('saveSpinner');
            const saveButtonText = document.getElementById('saveButtonText');
            
            // Show loading state
            saveButton.disabled = true;
            saveSpinner.classList.remove('hidden');
            saveButtonText.textContent = 'Saving...';
            
            try {
                // Simulate API call
                await new Promise(resolve => setTimeout(resolve, 1500));
                
                const dayNames = selectedDays.map(day => day.charAt(0).toUpperCase() + day.slice(1));
                hasUnsavedChanges = false;
                
                showToast(`Schedule saved! WFH days: ${dayNames.join(', ')}`, 'success', 4000);
                
                // Save final state
                saveToLocalStorage();
                
            } catch (error) {
                showToast('Failed to save schedule. Please try again.', 'error', 4000);
            } finally {
                // Hide loading state
                saveSpinner.classList.add('hidden');
                updateSaveButtonState();
            }
        }

        // Keyboard navigation
        function setupKeyboardNavigation() {
            document.addEventListener('keydown', (e) => {
                const focusedElement = document.activeElement;
                
                if (focusedElement && focusedElement.classList.contains('day-selector')) {
                    const buttons = Array.from(document.querySelectorAll('.day-selector'));
                    const currentIndex = buttons.indexOf(focusedElement);
                    
                    switch(e.key) {
                        case 'Enter':
                        case ' ':
                            e.preventDefault();
                            focusedElement.click();
                            break;
                        case 'ArrowLeft':
                            e.preventDefault();
                            if (currentIndex > 0) buttons[currentIndex - 1].focus();
                            break;
                        case 'ArrowRight':
                            e.preventDefault();
                            if (currentIndex < buttons.length - 1) buttons[currentIndex + 1].focus();
                            break;
                        case 'Home':
                            e.preventDefault();
                            buttons[0].focus();
                            break;
                        case 'End':
                            e.preventDefault();
                            buttons[buttons.length - 1].focus();
                            break;
                    }
                }
            });
        }

        // Event listeners
        function setupEventListeners() {
            // Day selectors (delegated event handling)
            document.getElementById('day-selector-container').addEventListener('click', function(e) {
                const button = e.target.closest('.day-selector');
                if (button) {
                    const day = button.getAttribute('data-day');
                    updateDaySelector(button, day);
                }
            });

            // Date navigation buttons
            document.getElementById('prevWeek').addEventListener('click', () => changeWeek(-1));
            document.getElementById('nextWeek').addEventListener('click', () => changeWeek(1));

            // Action buttons
            document.getElementById('saveButton').addEventListener('click', saveSchedule);
            document.getElementById('clearButton').addEventListener('click', clearAllSelections);
            
            // Logout button
            document.querySelector('[aria-label="Logout"]').addEventListener('click', async () => {
                await authManager.signOut();
            });
        }

        // Initialize the application
        async function init() {
            // Check authentication
            const isAuthenticated = await authManager.checkAuth();
            if (!isAuthenticated) return;

            try {
                // Get user profile
                console.log('Attempting to load user profile...');
                const { profile, error } = await authManager.getUserProfile();
                
                if (error) {
                    console.error('Profile fetch error:', error);
                    
                    // If error is related to missing profile, try to create one
                    if (error.code === 'PGRST116' || error.message?.includes('not found')) {
                        console.log('Profile not found, attempting to create...');
                        const { user } = await authManager.getUser();
                        const createResult = await authManager.createOrUpdateProfile({
                            full_name: user.user_metadata?.full_name || user.email.split('@')[0],
                            department: '',
                            role: ''
                        });
                        
                        if (createResult.error) {
                            console.error('Failed to create profile:', createResult.error);
                            throw createResult.error;
                        } else {
                            console.log('Profile created successfully');
                            document.getElementById('user-name').querySelector('p').textContent = user.email.split('@')[0];
                        }
                    } else {
                        throw error;
                    }
                } else if (profile) {
                    console.log('Profile loaded successfully:', profile);
                    document.getElementById('user-name').querySelector('p').textContent = profile.full_name || profile.email.split('@')[0];
                } else {
                    console.log('No profile found, creating new one...');
                    // Create profile if it doesn't exist
                    const { user } = await authManager.getUser();
                    const createResult = await authManager.createOrUpdateProfile({
                        full_name: user.user_metadata?.full_name || user.email.split('@')[0],
                        department: '',
                        role: ''
                    });
                    
                    if (createResult.error) {
                        console.error('Failed to create profile:', createResult.error);
                        throw createResult.error;
                    }
                    
                    document.getElementById('user-name').querySelector('p').textContent = user.email.split('@')[0];
                }

                // Load saved data from backend
                await loadWeeklyScheduleFromBackend();
                
                // Render initial UI
                updateWeekDisplay();
                await loadOfficeSchedule();
                updateSelectionCounter();
                updateSaveButtonState();
                
                // Setup interactions
                setupEventListeners();
                setupKeyboardNavigation();
                setupOfficeTableEventListeners();
                setupVacationEventListeners();
                
                // Load vacation status
                await updateVacationStatus();
                
                // Setup real-time updates
                setupRealtimeUpdates();
                
                // Show welcome message
                setTimeout(() => {
                    showToast('Welcome! Select your work from home days for the week.', 'success', 3000);
                }, 500);

            } catch (error) {
                console.error('Initialization error:', error);
                showToast('Failed to load user data. Please refresh the page.', 'error', 5000);
            }
        }

        // Backend integration functions
        async function loadWeeklyScheduleFromBackend() {
            try {
                const weekStart = scheduleManager.getWeekStart(currentWeekStart);
                const { data, error } = await scheduleManager.getWeeklySchedule(weekStart);
                
                if (!error && data) {
                    // Convert WFH days array to day names
                    const dayMap = { 1: 'monday', 2: 'tuesday', 3: 'wednesday', 4: 'thursday', 5: 'friday' };
                    selectedDays = data.wfh_days.map(dayNum => dayMap[dayNum]).filter(Boolean);
                    hasUnsavedChanges = false;
                }
            } catch (error) {
                console.error('Failed to load weekly schedule:', error);
            }
        }

        async function saveToBackend() {
            try {
                const weekStart = scheduleManager.getWeekStart(currentWeekStart);
                
                // Convert day names to numbers (1=Monday, 5=Friday)
                const dayMap = { 'monday': 1, 'tuesday': 2, 'wednesday': 3, 'thursday': 4, 'friday': 5 };
                const wfhDays = selectedDays.map(day => dayMap[day]).filter(Boolean);
                
                const { data, error } = await scheduleManager.saveWeeklySchedule(weekStart, wfhDays);
                
                if (error) throw error;
                
                hasUnsavedChanges = false;
                return data;
            } catch (error) {
                console.error('Failed to save to backend:', error);
                throw error;
            }
        }

        // Legacy function - now handled by loadOfficeSchedule
        async function renderEmployeeList() {
            // Redirect to new office schedule table
            await loadOfficeSchedule();
        }

        function setupRealtimeUpdates() {
            // Subscribe to office attendance updates
            realtimeManager.subscribeToOfficeAttendance(async (payload) => {
                console.log('Office attendance updated:', payload);
                // Refresh the office schedule table
                await loadOfficeSchedule();
            });

            // Subscribe to user's own schedule updates
            authManager.getUser().then(({ user }) => {
                if (user) {
                    realtimeManager.subscribeToUserSchedules(user.id, (payload) => {
                        console.log('User schedule updated:', payload);
                        // Refresh current schedule if it affects current week
                        loadWeeklyScheduleFromBackend();
                        // Also refresh office table if the change affects the displayed week
                        loadOfficeSchedule();
                    });
                }
            });
        }

        // ===============================
        // VACATION MANAGEMENT FUNCTIONS
        // ===============================

        // Vacation modal management
        function openVacationModal() {
            const modal = document.getElementById('vacationModal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            
            // Load existing vacation data
            loadCurrentVacation();
            
            // Focus on start date input
            setTimeout(() => {
                document.getElementById('vacationStartDate').focus();
            }, 100);
        }

        function closeVacationModal() {
            const modal = document.getElementById('vacationModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            
            // Clear form
            clearVacationForm();
        }

        function clearVacationForm() {
            document.getElementById('vacationStartDate').value = '';
            document.getElementById('vacationEndDate').value = '';
            document.getElementById('vacationNotes').value = '';
            document.getElementById('vacationSummary').classList.add('hidden');
            document.getElementById('clearVacationBtn').classList.add('hidden');
        }

        // Load current vacation from backend
        async function loadCurrentVacation() {
            try {
                const vacation = await scheduleManager.getCurrentVacation();
                if (vacation) {
                    // Populate form with existing data
                    document.getElementById('vacationStartDate').value = vacation.start_date;
                    document.getElementById('vacationEndDate').value = vacation.end_date;
                    document.getElementById('vacationNotes').value = vacation.notes || '';
                    document.getElementById('clearVacationBtn').classList.remove('hidden');
                    
                    // Update summary
                    updateVacationSummary();
                }
            } catch (error) {
                console.error('Failed to load current vacation:', error);
            }
        }

        // Update vacation status display
        async function updateVacationStatus() {
            try {
                const vacation = await scheduleManager.getCurrentVacation();
                const noVacationMessage = document.getElementById('noVacationMessage');
                const vacationDetails = document.getElementById('vacationDetails');
                
                if (vacation && vacation.start_date && vacation.end_date) {
                    const startDate = new Date(vacation.start_date);
                    const endDate = new Date(vacation.end_date);
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    
                    // Check if vacation is active, upcoming, or past
                    const isActive = today >= startDate && today <= endDate;
                    const isUpcoming = today < startDate;
                    
                    if (isActive || isUpcoming) {
                        noVacationMessage.classList.add('hidden');
                        vacationDetails.classList.remove('hidden');
                        
                        // Update dates display
                        const options = { year: 'numeric', month: 'short', day: 'numeric' };
                        const startStr = startDate.toLocaleDateString('en-US', options);
                        const endStr = endDate.toLocaleDateString('en-US', options);
                        document.getElementById('vacationDates').textContent = `${startStr} - ${endStr}`;
                        
                        // Calculate days
                        const diffTime = Math.abs(endDate - startDate);
                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
                        document.getElementById('vacationDaysCount').textContent = `${diffDays} day${diffDays > 1 ? 's' : ''}`;
                        
                        // Update status indicator
                        const statusIndicator = vacationDetails.querySelector('.w-3.h-3');
                        const statusText = vacationDetails.querySelector('.text-sm.font-medium');
                        
                        if (isActive) {
                            statusIndicator.className = 'w-3 h-3 bg-orange-400 rounded-full';
                            statusText.className = 'text-sm font-medium text-orange-400';
                            statusText.textContent = 'On Vacation';
                        } else {
                            statusIndicator.className = 'w-3 h-3 bg-blue-400 rounded-full';
                            statusText.className = 'text-sm font-medium text-blue-400';
                            statusText.textContent = 'Vacation Scheduled';
                        }
                    } else {
                        // Past vacation
                        noVacationMessage.classList.remove('hidden');
                        vacationDetails.classList.add('hidden');
                    }
                } else {
                    noVacationMessage.classList.remove('hidden');
                    vacationDetails.classList.add('hidden');
                }
            } catch (error) {
                console.error('Failed to update vacation status:', error);
            }
        }

        // Update vacation summary in modal
        function updateVacationSummary() {
            const startDate = document.getElementById('vacationStartDate').value;
            const endDate = document.getElementById('vacationEndDate').value;
            
            if (startDate && endDate) {
                const start = new Date(startDate);
                const end = new Date(endDate);
                
                if (end >= start) {
                    const diffTime = Math.abs(end - start);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
                    
                    const options = { year: 'numeric', month: 'short', day: 'numeric' };
                    const startStr = start.toLocaleDateString('en-US', options);
                    const endStr = end.toLocaleDateString('en-US', options);
                    
                    document.getElementById('vacationSummaryText').textContent = 
                        `${diffDays} day${diffDays > 1 ? 's' : ''} vacation from ${startStr} to ${endStr}`;
                    document.getElementById('vacationSummary').classList.remove('hidden');
                } else {
                    document.getElementById('vacationSummary').classList.add('hidden');
                }
            } else {
                document.getElementById('vacationSummary').classList.add('hidden');
            }
        }

        // Save vacation to backend
        async function saveVacation() {
            const startDate = document.getElementById('vacationStartDate').value;
            const endDate = document.getElementById('vacationEndDate').value;
            const notes = document.getElementById('vacationNotes').value.trim();
            
            if (!startDate || !endDate) {
                showToast('Please select both start and end dates.', 'error', 3000);
                return;
            }
            
            const start = new Date(startDate);
            const end = new Date(endDate);
            
            if (end < start) {
                showToast('End date must be after start date.', 'error', 3000);
                return;
            }
            
            const saveButton = document.getElementById('saveVacationBtn');
            const spinner = document.getElementById('vacationSaveSpinner');
            
            // Show loading state
            saveButton.disabled = true;
            spinner.classList.remove('hidden');
            
            try {
                await scheduleManager.saveVacation(startDate, endDate, notes);
                
                const diffTime = Math.abs(end - start);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
                
                showToast(`Vacation saved! ${diffDays} day${diffDays > 1 ? 's' : ''} scheduled.`, 'success', 4000);
                
                closeVacationModal();
                await updateVacationStatus();
                await loadOfficeSchedule(); // Refresh table to show vacation status
                
            } catch (error) {
                console.error('Save vacation error:', error);
                showToast('Failed to save vacation. Please try again.', 'error', 4000);
            } finally {
                saveButton.disabled = false;
                spinner.classList.add('hidden');
            }
        }

        // Clear vacation
        async function clearVacation() {
            if (!confirm('Are you sure you want to clear your vacation? This action cannot be undone.')) {
                return;
            }
            
            try {
                await scheduleManager.clearVacation();
                showToast('Vacation cleared successfully.', 'success', 3000);
                
                closeVacationModal();
                await updateVacationStatus();
                await loadOfficeSchedule(); // Refresh table
                
            } catch (error) {
                console.error('Clear vacation error:', error);
                showToast('Failed to clear vacation. Please try again.', 'error', 4000);
            }
        }

        // Setup vacation event listeners
        function setupVacationEventListeners() {
            // Modal triggers
            document.getElementById('setVacationBtn').addEventListener('click', openVacationModal);
            document.getElementById('closeVacationModal').addEventListener('click', closeVacationModal);
            document.getElementById('cancelVacationBtn').addEventListener('click', closeVacationModal);
            
            // Form interactions
            document.getElementById('vacationStartDate').addEventListener('change', updateVacationSummary);
            document.getElementById('vacationEndDate').addEventListener('change', updateVacationSummary);
            
            // Save and clear actions
            document.getElementById('saveVacationBtn').addEventListener('click', saveVacation);
            document.getElementById('clearVacationBtn').addEventListener('click', clearVacation);
            
            // Close modal on backdrop click
            document.getElementById('vacationModal').addEventListener('click', (e) => {
                if (e.target.id === 'vacationModal') {
                    closeVacationModal();
                }
            });
            
            // ESC key to close modal
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    const modal = document.getElementById('vacationModal');
                    if (!modal.classList.contains('hidden')) {
                        closeVacationModal();
                    }
                }
            });
        }

        // Enhanced save functionality with backend integration
        async function saveSchedule() {
            if (selectedDays.length === 0) {
                showToast('Please select at least one day to work from home.', 'error', 3000);
                return;
            }

            const saveButton = document.getElementById('saveButton');
            const saveSpinner = document.getElementById('saveSpinner');
            const saveButtonText = document.getElementById('saveButtonText');
            
            // Show loading state
            saveButton.disabled = true;
            saveSpinner.classList.remove('hidden');
            saveButtonText.textContent = 'Saving...';
            
            try {
                await saveToBackend();
                
                const dayNames = selectedDays.map(day => day.charAt(0).toUpperCase() + day.slice(1));
                showToast(`Schedule saved! WFH days: ${dayNames.join(', ')}`, 'success', 4000);
                
                // Refresh office schedule table
                await loadOfficeSchedule();
                
            } catch (error) {
                console.error('Save error:', error);
                showToast('Failed to save schedule. Please try again.', 'error', 4000);
            } finally {
                // Hide loading state
                saveSpinner.classList.add('hidden');
                updateSaveButtonState();
            }
        }

        // Run when DOM is loaded
        document.addEventListener('DOMContentLoaded', init);
    </script>
    
    <!-- Include Supabase backend managers -->
    <script src="js/config.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/schedule.js"></script>
    <script src="js/realtime.js"></script>
</body>
</html> 